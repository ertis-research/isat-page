{{/* Partial: BloX Map - Dynamic geocoding with Leaflet + Nominatim */}}
{{ $block := .wcBlock }}
{{ $page := .wcPage }}

{{/* Fallback for different contexts */}}
{{ if not $block }}
  {{ if .content }}
    {{ $block = . }}
    {{ $page = site.Home }}
  {{ else if .Params }}
    {{ $block = .Params }}
    {{ $page = . }}
  {{ end }}
{{ end }}

{{ if $block }}

<section class="py-20 bg-slate-900 text-white relative">
  <div class="container mx-auto px-6 max-w-6xl relative z-10">
    <div class="text-center mb-12">
      <span class="text-blue-400 font-bold uppercase tracking-widest text-xs">{{ with $block.content.announcement }}{{ . }}{{ else }}Ubicación Estratégica{{ end }}</span>
      <h2 class="text-3xl font-bold mt-2">{{ $block.content.title }}</h2>
      {{ with $block.content.text }}<p class="text-gray-400 mt-4 max-w-2xl mx-auto">{{ . }}</p>{{ end }}
    </div>

    {{/* Get points from content */}}
    {{ $points := slice }}
    {{ if $block.content }}
      {{ with $block.content.points }}{{ $points = . }}{{ end }}
    {{ end }}

    {{ if gt (len $points) 0 }}
    <div class="bg-gray-800 rounded-2xl overflow-hidden shadow-2xl border border-gray-700 relative h-[500px]">
      
      {{/* Map container */}}
      {{ $mapId := printf "leaflet-map-%d" (now.Unix) }}
      <div id="{{ $mapId }}" class="w-full h-full z-0"></div>
      
      {{/* Leaflet CSS & JS */}}
      <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
      <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
      
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          console.log('iSAT Map: Script started');
          var points = JSON.parse('{{ $points | jsonify }}');
          console.log('iSAT Map: Points to process:', points);
          var mapId = '{{ $mapId }}';
          
          // Initialize map centered on Andalusia
          var map = L.map(mapId, { scrollWheelZoom: false }).setView([37.0, -4.8], 6);
          
          // OpenStreetMap tiles
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
          }).addTo(map);

          // Helper: Get marker color from Tailwind class
          function getMarkerColor(colorClass) {
            var colorMap = {
              'text-indigo-600': '#4f46e5',
              'text-blue-500': '#3b82f6',
              'text-emerald-500': '#10b981',
              'text-emerald-600': '#059669',
              'text-orange-500': '#f97316',
              'text-red-500': '#ef4444'
            };
            return colorMap[colorClass] || '#6b7280';
          }
          
          // Helper: Create custom colored marker icon
          function createColoredIcon(color) {
            return L.divIcon({
              className: 'custom-marker',
              html: '<div style="background-color: ' + color + '; width: 25px; height: 25px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"><div style="transform: rotate(45deg); width: 100%; height: 100%;"></div></div>',
              iconSize: [25, 25],
              iconAnchor: [12, 25],
              popupAnchor: [0, -25]
            });
          }

          // Hardcoded coordinates mapping
          var locationCoords = {
            "Teba": { lat: 36.980539, lon: -4.880926 },
            "Sierra de Líbar (Benaoján)": { lat: 36.871269, lon: -5.044803 },
            "Cuevas del Becerro": { lat: 36.871269, lon: -5.044803 },
            "Sierra de Yeguas": { lat: 37.149253, lon: -4.855323 },
            "Villanueva de Tapia": { lat: 37.143270, lon: -4.342527 }
          };
          
          function processPoints() {
            var markers = [];
            
            for (var i = 0; i < points.length; i++) {
              var point = points[i];
              var coords = locationCoords[point.title];
              
              if (coords) {
                console.log('iSAT Map: Adding marker for:', point.title, 'at', coords.lat, coords.lon);
                var color = getMarkerColor(point.color);
                var icon = createColoredIcon(color);
                
                var marker = L.marker([coords.lat, coords.lon], { icon: icon })
                  .bindPopup('<strong>' + point.title + '</strong><br/>' + (point.subtitle || ''))
                  .addTo(map);
                markers.push(marker);
              } else {
                console.warn('iSAT Map: No coordinates found for:', point.title);
              }
            }
            
            // Fit map to show all markers
            if (markers.length > 0) {
              console.log('iSAT Map: Fitting bounds for', markers.length, 'markers');
              var group = L.featureGroup(markers);
              try {
                map.fitBounds(group.getBounds(), { padding: [80, 80], maxZoom: 8 });
              } catch(e) {
                console.error('iSAT Map: Error fitting bounds:', e);
              }
            } else {
              console.warn('iSAT Map: No markers created to fit bounds');
            }
            
            // Force map resize
            setTimeout(function(){ map.invalidateSize(); }, 100);
          }
          
          processPoints();
        });
      </script>

      {{/* Legend overlay */}}
      <div class="absolute bottom-6 left-6 bg-white/90 backdrop-blur text-gray-800 p-4 rounded-xl shadow-xl max-w-xs hidden md:block">
        <h4 class="font-bold border-b border-gray-200 pb-2 mb-2">Puntos de Validación</h4>
        <ul class="space-y-2 text-sm">
          {{ range $points }}
          <li class="flex items-start gap-2 {{ if .opacity }}opacity-70{{ end }}">
            <i class="fas fa-map-marker-alt {{ if .color }}{{ .color }}{{ else }}text-gray-500{{ end }} mt-1"></i>
            <div>
              <span class="font-semibold block">{{ .title }}</span>
              <span class="text-xs text-gray-500">{{ .subtitle }}</span>
            </div>
          </li>
          {{ end }}
        </ul>
      </div>

    </div>
    {{ else }}
    <div class="bg-gray-800 rounded-2xl overflow-hidden shadow-2xl border border-gray-700 relative h-[500px]">
      <div class="w-full h-full flex items-center justify-center text-gray-400">
        No hay puntos configurados para el mapa.
      </div>
    </div>
    {{ end }}

  </div>
</section>
{{ end }}
